<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Exchange Bot - Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }
        
        h1 {
            font-size: 2.5rem;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .refresh-info {
            font-size: 0.9rem;
            color: #666;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        
        .stat-value {
            font-size: 2.2rem;
            font-weight: bold;
        }
        
        .charts-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .chart-title {
            font-size: 1.3rem;
            color: #667eea;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 10px;
            overflow: hidden;
        }
        
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        tr:hover {
            background: #f5f5f5;
        }
        
        .health-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
        }
        
        .health-healthy {
            background: #4caf50;
            color: white;
        }
        
        .health-warning {
            background: #ff9800;
            color: white;
        }
        
        .health-critical {
            background: #f44336;
            color: white;
        }
        
        .export-buttons {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
        }
        
        .btn {
            padding: 10px 25px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸ“Š Exchange Bot Dashboard</h1>
            <p class="refresh-info">Auto-refresh cada 10 segundos | Ãšltima actualizaciÃ³n: <span id="last-update">--:--:--</span></p>
        </header>
        
        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Interacciones</div>
                <div class="stat-value" id="total-interactions">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Tasa de Ã‰xito</div>
                <div class="stat-value" id="success-rate">0%</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ROI Global</div>
                <div class="stat-value" id="global-roi">0.00</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Costo Total (EUR)</div>
                <div class="stat-value" id="total-cost">â‚¬0.00</div>
            </div>
        </div>
        
        <!-- Charts Row 1 -->
        <div class="charts-row">
            <div class="chart-container">
                <div class="chart-title">DistribuciÃ³n por Plataforma</div>
                <div id="platform-chart"></div>
            </div>
            <div class="chart-container">
                <div class="chart-title">Ã‰xitos vs Fallos</div>
                <div id="success-chart"></div>
            </div>
        </div>
        
        <!-- Charts Row 2 -->
        <div class="charts-row">
            <div class="chart-container">
                <div class="chart-title">Top 10 Grupos por ROI</div>
                <div id="groups-chart"></div>
            </div>
            <div class="chart-container">
                <div class="chart-title">Top 10 Usuarios</div>
                <div id="users-chart"></div>
            </div>
        </div>
        
        <!-- Export Buttons -->
        <div class="export-buttons">
            <a href="/exchange/dashboard/export/csv?entity_type=groups" class="btn btn-primary" download>
                ðŸ“¥ Exportar Grupos (CSV)
            </a>
            <a href="/exchange/dashboard/export/csv?entity_type=users" class="btn btn-primary" download>
                ðŸ“¥ Exportar Usuarios (CSV)
            </a>
            <a href="/exchange/dashboard/export/json" class="btn btn-secondary" download>
                ðŸ“¦ Exportar JSON Completo
            </a>
        </div>
        
        <!-- Health Status -->
        <div class="chart-container">
            <div class="chart-title">Estado del Sistema</div>
            <p>Estado: <span id="health-status" class="health-status health-healthy">Saludable</span></p>
            <ul id="recommendations" style="margin-top: 15px; color: #666;"></ul>
        </div>
        
        <!-- Recent Errors Table -->
        <div class="chart-container">
            <div class="chart-title">Errores Recientes (Ãºltimas 24h)</div>
            <table id="errors-table">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Plataforma</th>
                        <th>Tipo</th>
                        <th>Error</th>
                        <th>Account ID</th>
                    </tr>
                </thead>
                <tbody id="errors-tbody">
                    <tr><td colspan="5" style="text-align:center;">Cargando...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <script>
        // Dashboard state
        let dashboardData = null;
        
        // Update timestamp
        function updateTimestamp() {
            const now = new Date();
            document.getElementById('last-update').textContent = now.toLocaleTimeString();
        }
        
        // Fetch dashboard data
        async function fetchDashboardData() {
            try {
                const response = await fetch('/exchange/dashboard/overview?period=daily');
                dashboardData = await response.json();
                updateDashboard();
            } catch (error) {
                console.error('Error fetching dashboard data:', error);
            }
        }
        
        // Update all dashboard components
        function updateDashboard() {
            if (!dashboardData) return;
            
            // Update stats cards
            document.getElementById('total-interactions').textContent = 
                dashboardData.totals.total_executions.toLocaleString();
            document.getElementById('success-rate').textContent = 
                (dashboardData.totals.success_rate * 100).toFixed(1) + '%';
            document.getElementById('global-roi').textContent = 
                dashboardData.roi.global_roi.toFixed(2);
            document.getElementById('total-cost').textContent = 
                'â‚¬' + dashboardData.roi.total_cost_eur.toFixed(2);
            
            // Update platform chart
            updatePlatformChart();
            
            // Update success/fail chart
            updateSuccessChart();
            
            // Update groups chart
            updateGroupsChart();
            
            // Update users chart
            updateUsersChart();
            
            // Update health status
            updateHealthStatus();
            
            // Update errors table
            updateErrorsTable();
            
            updateTimestamp();
        }
        
        // Platform distribution chart (Pie)
        function updatePlatformChart() {
            const platforms = dashboardData.platforms;
            
            const data = [{
                values: [platforms.youtube, platforms.instagram, platforms.tiktok],
                labels: ['YouTube', 'Instagram', 'TikTok'],
                type: 'pie',
                marker: {
                    colors: ['#FF0000', '#E4405F', '#000000']
                }
            }];
            
            const layout = {
                height: 300,
                margin: { t: 0, b: 0, l: 0, r: 0 },
                showlegend: true
            };
            
            Plotly.newPlot('platform-chart', data, layout, {responsive: true});
        }
        
        // Success vs Fail chart (Donut)
        function updateSuccessChart() {
            const totals = dashboardData.totals;
            
            const data = [{
                values: [totals.successful_executions, totals.failed_executions],
                labels: ['Exitosas', 'Fallidas'],
                type: 'pie',
                hole: 0.4,
                marker: {
                    colors: ['#4CAF50', '#F44336']
                }
            }];
            
            const layout = {
                height: 300,
                margin: { t: 0, b: 0, l: 0, r: 0 },
                showlegend: true
            };
            
            Plotly.newPlot('success-chart', data, layout, {responsive: true});
        }
        
        // Top groups chart (Bar)
        async function updateGroupsChart() {
            try {
                const response = await fetch('/exchange/dashboard/groups?limit=10&sort_by=roi_ratio');
                const groupsData = await response.json();
                
                const data = [{
                    x: groupsData.groups.map(g => g.group_name),
                    y: groupsData.groups.map(g => g.roi_ratio),
                    type: 'bar',
                    marker: {
                        color: '#667eea'
                    }
                }];
                
                const layout = {
                    height: 300,
                    margin: { t: 20, b: 100, l: 50, r: 20 },
                    xaxis: { tickangle: -45 },
                    yaxis: { title: 'ROI Ratio' }
                };
                
                Plotly.newPlot('groups-chart', data, layout, {responsive: true});
            } catch (error) {
                console.error('Error updating groups chart:', error);
            }
        }
        
        // Top users chart (Bar)
        async function updateUsersChart() {
            try {
                const response = await fetch('/exchange/dashboard/users?limit=10&min_interactions=5');
                const usersData = await response.json();
                
                const data = [{
                    x: usersData.users.map(u => u.username),
                    y: usersData.users.map(u => u.total_interactions),
                    type: 'bar',
                    marker: {
                        color: '#764ba2'
                    }
                }];
                
                const layout = {
                    height: 300,
                    margin: { t: 20, b: 100, l: 50, r: 20 },
                    xaxis: { tickangle: -45 },
                    yaxis: { title: 'Total Interacciones' }
                };
                
                Plotly.newPlot('users-chart', data, layout, {responsive: true});
            } catch (error) {
                console.error('Error updating users chart:', error);
            }
        }
        
        // Health status
        function updateHealthStatus() {
            const health = dashboardData.health;
            const statusEl = document.getElementById('health-status');
            
            statusEl.textContent = health.status.charAt(0).toUpperCase() + health.status.slice(1);
            statusEl.className = 'health-status health-' + health.status;
            
            const recommendationsEl = document.getElementById('recommendations');
            recommendationsEl.innerHTML = health.recommendations
                .map(r => `<li>${r}</li>`)
                .join('');
        }
        
        // Errors table
        async function updateErrorsTable() {
            try {
                const response = await fetch('/exchange/dashboard/errors?hours=24&limit=20');
                const errorsData = await response.json();
                
                const tbody = document.getElementById('errors-tbody');
                
                if (errorsData.errors.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No hay errores recientes</td></tr>';
                    return;
                }
                
                tbody.innerHTML = errorsData.errors.map(err => `
                    <tr>
                        <td>${new Date(err.timestamp).toLocaleString()}</td>
                        <td>${err.platform}</td>
                        <td>${err.interaction_type}</td>
                        <td>${err.error}</td>
                        <td>${err.account_id}</td>
                    </tr>
                `).join('');
                
            } catch (error) {
                console.error('Error updating errors table:', error);
            }
        }
        
        // Initial load
        fetchDashboardData();
        
        // Auto-refresh every 10 seconds
        setInterval(fetchDashboardData, 10000);
    </script>
</body>
</html>
