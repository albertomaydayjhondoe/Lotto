name: Enforce L√≠nea Maestra + Checklist Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - integracion/cto-ready

  push:
    branches:
      - main
      - integracion/cto-ready

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  validate-checklist:
    name: Validate Mandatory Checklist
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pytest pytest-cov pydantic || true
          if [ -f backend/requirements.txt ]; then
            pip install -r backend/requirements.txt || true
          fi
      
      - name: Run validation script
        id: validate
        run: |
          echo "Running checklist validator..."
          python scripts/validate_checklist.py
          EXIT_CODE=$?
          echo "validation_exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          exit 0
        continue-on-error: true
      
      - name: Check validation output
        id: check_output
        run: |
          if [ ! -f scripts/validate_output.json ]; then
            echo "‚ùå ERROR: validate_output.json not generated!"
            echo "status=error" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Extract status from JSON
          STATUS=$(python -c "import json; print(json.load(open('scripts/validate_output.json'))['status'])")
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          
          # Display validation output
          echo "üìä Validation Results:"
          cat scripts/validate_output.json | python -m json.tool
          
          if [ "$STATUS" == "fail" ]; then
            echo "‚ùå Validation FAILED - see violations above"
            exit 1
          elif [ "$STATUS" == "warning" ]; then
            echo "‚ö†Ô∏è Validation passed with WARNINGS"
            exit 0
          else
            echo "‚úÖ Validation PASSED"
            exit 0
          fi
      
      - name: Upload validation report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: validation-report
          path: scripts/validate_output.json
          retention-days: 30
      
      - name: Comment PR with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const fs = require('fs');
            let report;
            
            try {
              report = JSON.parse(fs.readFileSync('scripts/validate_output.json', 'utf8'));
            } catch (error) {
              report = {
                status: 'error',
                message: 'Failed to read validation output',
                violations: ['validate_output.json not found']
              };
            }
            
            const statusEmoji = {
              'ok': '‚úÖ',
              'warning': '‚ö†Ô∏è',
              'fail': '‚ùå',
              'error': 'üî•'
            };
            
            let body = `## ${statusEmoji[report.status]} Checklist Validation Results\n\n`;
            body += `**Status:** ${report.status.toUpperCase()}\n\n`;
            
            if (report.message) {
              body += `**Message:** ${report.message}\n\n`;
            }
            
            if (report.violations && report.violations.length > 0) {
              body += `### üö® Violations (${report.violations.length})\n\n`;
              report.violations.forEach((v, i) => {
                body += `${i + 1}. ${v}\n`;
              });
              body += `\n`;
            }
            
            if (report.warnings && report.warnings.length > 0) {
              body += `### ‚ö†Ô∏è Warnings (${report.warnings.length})\n\n`;
              report.warnings.forEach((w, i) => {
                body += `${i + 1}. ${w}\n`;
              });
              body += `\n`;
            }
            
            if (report.passed && report.passed.length > 0) {
              body += `### ‚úÖ Passed Checks (${report.passed.length})\n\n`;
              body += `<details><summary>View details</summary>\n\n`;
              report.passed.forEach((p, i) => {
                body += `- ${p}\n`;
              });
              body += `\n</details>\n\n`;
            }
            
            body += `---\n`;
            body += `üìö **Reference:** [L√≠nea Maestra de Desarrollo](../docs/LINEA_MAESTRA_DESARROLLO.txt) | [Checklist Obligatorio](../docs/CHECKLIST_OBLIGATORIO.md)\n`;
            
            try {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            } catch (error) {
              console.log('Failed to post comment (permissions issue):', error.message);
              console.log('Validation results:', JSON.stringify(report, null, 2));
            }

  security-scan:
    name: Security Scan (Secrets Detection)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified
        continue-on-error: true
      
      - name: Scan for common secrets patterns
        run: |
          echo "üîç Scanning for exposed secrets..."
          
          # Define patterns for common secrets
          PATTERNS=(
            "api[_-]?key"
            "api[_-]?secret"
            "access[_-]?token"
            "auth[_-]?token"
            "password\s*="
            "passwd\s*="
            "pwd\s*="
            "secret\s*="
            "aws[_-]?access"
            "aws[_-]?secret"
            "private[_-]?key"
            "client[_-]?secret"
            "bearer\s+[A-Za-z0-9\-\._~\+\/]+"
          )
          
          FOUND_SECRETS=0
          
          for pattern in "${PATTERNS[@]}"; do
            if git diff origin/main HEAD | grep -iE "$pattern" | grep -v "example" | grep -v ".env.example"; then
              echo "‚ö†Ô∏è Potential secret found matching pattern: $pattern"
              FOUND_SECRETS=1
            fi
          done
          
          if [ $FOUND_SECRETS -eq 1 ]; then
            echo "‚ùå CRITICAL: Potential secrets detected in diff!"
            echo "Please review the changes and remove any exposed credentials."
            exit 1
          else
            echo "‚úÖ No obvious secrets detected"
          fi

  lint-and-format:
    name: Code Quality (Linting)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort mypy
      
      - name: Run flake8
        run: |
          echo "üîç Running flake8..."
          flake8 backend/app/ --max-line-length=100 --exclude=__pycache__,*.pyc,alembic --exit-zero
        continue-on-error: true
      
      - name: Check black formatting
        run: |
          echo "üé® Checking code formatting..."
          black backend/app/ --check --line-length=100 --exclude="alembic|__pycache__" --diff
        continue-on-error: true
      
      - name: Check import sorting
        run: |
          echo "üì¶ Checking import order..."
          isort backend/app/ --check-only --profile black --line-length=100
        continue-on-error: true

  test-suite:
    name: Run Test Suite
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-asyncio
          
          # Install project dependencies
          if [ -f backend/requirements.txt ]; then
            pip install -r backend/requirements.txt
          fi
      
      - name: Run tests with coverage
        run: |
          echo "üß™ Running test suite..."
          cd backend
          export PYTHONPATH="${PYTHONPATH}:$(pwd)"
          pytest -v --cov=app --cov-report=term-missing --cov-report=xml --cov-report=html || true
        continue-on-error: true
      
      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: backend/htmlcov/
          retention-days: 30

  notify-on-failure:
    name: Notify on Critical Failure
    runs-on: ubuntu-latest
    needs: [validate-checklist, security-scan]
    if: failure()
    
    steps:
      - name: Create GitHub Issue
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const title = `üö® CI Validation Failed: ${context.payload.pull_request?.title || context.sha.substring(0, 7)}`;
            const body = `
            ## Critical CI Failure
            
            **Pull Request:** ${context.payload.pull_request?.html_url || 'N/A'}
            **Branch:** ${context.ref}
            **Commit:** ${context.sha}
            **Workflow Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
            
            One or more critical checks have failed:
            - Checklist validation
            - Security scan
            
            **Action Required:**
            1. Review the workflow run details
            2. Check \`scripts/validate_output.json\` for violations
            3. Fix all critical issues
            4. Re-run the workflow
            
            cc: @sistemaproyectomunidal
            `;
            
            try {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['ci-failure', 'urgent']
              });
            } catch (error) {
              console.log('Failed to create issue (permissions):', error.message);
            }
      
      - name: Send Telegram notification (if configured)
        if: env.TELEGRAM_BOT_TOKEN != '' && env.TELEGRAM_CHAT_ID != ''
        run: |
          MESSAGE="üö® STAKAZO CI FAILED%0A%0APR: ${{ github.event.pull_request.title }}%0ACommit: ${{ github.sha }}%0A%0ACheck GitHub Actions for details."
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=${MESSAGE}" \
            -d "parse_mode=HTML"
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
